buildscript {
    repositories aliyun_repositories
}
plugins {
    id "org.inferred.processors" version "3.3.0"
    id "java"
}

group = String.format("%s.%s", project.main_group, project.getName())
version = project.main_version
sourceCompatibility = project.java_version
targetCompatibility = project.java_version

repositories.clear()
repositories.addAll(buildscript.repositories)

def slf4jVersion = "1.7.15"
dependencies {
    implementation(project(":core"))
    implementation(project(":agent"))
    implementation(project(":ssh"))
    processor "org.inferred:freebuilder:2.6.1"
    implementation("com.google.guava:guava:29.0-jre")
    implementation("org.apache.commons:commons-lang3:3.0")
    implementation("org.slf4j:slf4j-api:${slf4jVersion}")
    implementation("org.freemarker:freemarker:2.3.9")
    implementation("info.picocli:picocli:4.5.0")
    implementation("commons-io:commons-io:2.4")
    // TODO use logback
    implementation("org.slf4j:slf4j-simple:${slf4jVersion}")
    testImplementation("junit:junit:4.12")
    testImplementation("org.slf4j:slf4j-simple:${slf4jVersion}")
}
test {
    useJUnit()
}
def jarName = "${project.getName()}-with-dependencies"
jar {
    manifest {
        attributes(
                'Implementation-Title': 'blackhole.dist',
                'Implementation-Version': project.getVersion(),
                'Main-Class': 'tech.geekcity.blackhole.dist.EntryPoint'
        )
    }
    setArchivesBaseName(jarName)
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
}

// ********************** build docker images **********************
def httpProxy = java.util.Optional.ofNullable(System.getenv("http_proxy")).orElse("")
def httpsProxy = java.util.Optional.ofNullable(System.getenv("https_proxy")).orElse("")
def baseImageName = "blackhole_base:${project.getVersion()}"
task buildBaseDim(type: Exec) {
    executable("docker")
    args(
            "build", "${project.file("dim/base")}",
            "-f", "${project.file("dim/base/base.centos.dockerfile")}",
            "--build-arg", "http_proxy=${httpProxy}",
            "--build-arg", "https_proxy=${httpsProxy}",
            "-t", baseImageName,
    )
    doFirst {
        println(String.format("running command: %s", String.join(" ", getCommandLine())))
    }
}
def sshdImageName = "blackhole_sshd:${project.getVersion()}"
task buildSshdDim(type: Exec) {
    executable("docker")
    args(
            "build", project.file("dim/base").getAbsolutePath(),
            "-f", project.file("dim/sshd/sshd.dockerfile").getAbsolutePath(),
            "--build-arg", "http_proxy=${httpProxy}",
            "--build-arg", "https_proxy=${httpsProxy}",
            "--build-arg", "BASE_IMAGE=${baseImageName}",
            "-t", sshdImageName,
    )
    doFirst {
        println(String.format("running command: %s", String.join(" ", getCommandLine())))
    }
    dependsOn(buildBaseDim)
}
// ********************** running test envrionment with docker **********************
def keyPairFilePath = project.file("dim/sshd/id_rsa.key.pair").getAbsolutePath()
task generateRsaKeyFiles(type: Exec) {
    executable("java")
    args(
            "-jar", project.file("build/libs/${jarName}-${project.getVersion()}.jar"),
            "tech.geekcity.blackhole.dist.RsaKeyGenerator",
            "--idRsaFile", project.file("dim/sshd/id_rsa").getAbsolutePath(),
            "--idRsaPubFile", project.file("dim/sshd/id_rsa.pub").getAbsolutePath(),
            "--keyPairFile", keyPairFilePath,
            // "--overwrite",
    )
    doFirst {
        println(String.format("running command: %s", String.join(" ", getCommandLine())))
    }
    dependsOn(assemble)
}
def sshdDockerName = "sshd_server"
def sshdPort = "2222"
task runSshd(type: Exec) {
    executable("docker")
    args(
            "run",
            "--rm",
            "-p", "${sshdPort}:22",
            "--name", sshdDockerName,
            "-d", sshdImageName,
    )
    doFirst {
        println(String.format("running command: %s", String.join(" ", getCommandLine())))
    }
    doLast {
        exec {
            commandLine(
                    "docker", "exec", "--", "${sshdDockerName}",
                    "bash", "-c",
                    "echo ${project.file("dim/sshd/id_rsa.pub").getText()} >> /root/.ssh/authorized_keys",
            )
        }
        println("access with ssh client: ssh -i ${project.file("dim/sshd/id_rsa")} -p ${sshdPort} root@localhost")
    }
}
task stopSshd(type: Exec) {
    executable("docker")
    args(
            "kill",
            sshdDockerName,
    )
    doFirst {
        println(String.format("running command: %s", String.join(" ", getCommandLine())))
    }
}
// ********************** temp tasks(will be removed) **********************
task copyDistJarToRemote(type: Exec) {
    def distJar = project.file("build/libs/${jarName}-${project.getVersion()}.jar")
    executable("java")
    args(
            "-jar", distJar.getAbsolutePath(),
            "tech.geekcity.blackhole.dist.RemoteFileTransfer",
            "--username", "root",
            "--remoteHost", "localhost",
            "--remotePort", sshdPort,
            "--keyPairFile", keyPairFilePath,
            "--transferType", "upload",
            "--localFile", distJar.getAbsolutePath(),
            "--remoteFile", "/tmp/${distJar.getName()}",
    )
    doFirst {
        println(String.format("running command: %s", String.join(" ", getCommandLine())))
    }
    dependsOn(assemble)
}
